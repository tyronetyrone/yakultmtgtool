(window.webpackJsonp=window.webpackJsonp||[]).push([[6],{723:function(t,e,o){"use strict";o.d(e,"a",(function(){return i}));o(71),o(157),o(392),o(73),o(43),o(14),o(50),o(248),o(76);var n=o(779),r=o(780),a=o.n(r),i=function t(e){Object(n.a)(this,t),this.ak="",this.sk="",this.size=512e5,this.fileArr=[],this.option={host:e.host,key:e.key,bucketName:e.bucketName,bucketPath:e.bucketPath||"/default",error:e.error||function(){},beforeUpload:e.beforeUpload||function(){},uploadProgress:e.uploadProgress||function(){},fileUploaded:e.fileUploaded||function(){},ifAsync:"false"!==String(e.ifAsync),inseconds:"3000",stsPath:"/api/sts",uploadPath:"/api/upload",initPart:"/api/init-part",uploadPart:"/api/upload-part",compPart:"/api/parts-complete",abortPart:"/api/parts-abort",getMediaMeta:"/api/get-media-meta-data"}};i.prototype.bucketPathSet=function(t){this.option.bucketPath=t},i.prototype.start=function(){var t=this;for(var e in this.fileArr)t.fileArr[e].ignore||this.upload2(t.fileArr[e]).then((function(e){0!==e.retCode&&t.option.error(e)})).catch((function(e){t.option.error(e)}))},i.prototype.getCanonicalQueryString=function(t){var e=[];for(var o in t)e.push(encodeURIComponent(o.trim())+"="+encodeURIComponent(t[o].trim()));return e.sort().join("&")},i.prototype.getCanonicalHeaders=function(t){var e=[];for(var o in t)e.push(encodeURIComponent(o.trim().toLowerCase())+":"+encodeURIComponent(t[o].trim()));return e.sort().join("\n")},i.prototype.getAuthorization=function(t,e,o,n){var r=o+"\n"+this.getCanonicalQueryString(t)+"\n"+this.getCanonicalHeaders(e),i="";return i=n?this.option.key:this.sk,a.a.HmacSHA256(r,i)},i.prototype.ajax=function(t,e,o,n,r,a,i){var s="";for(var p in(s=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP")).open(n,this.option.host+t+"?"+this.getCanonicalQueryString(e),this.option.ifAsync),s.setRequestHeader("Authorization",this.getAuthorization(e,o,n,r)),o)"Content-Length"!==p&&"Content-Type"!==p&&s.setRequestHeader(p,o[p]);var u=new Promise((function(t,e){s.onreadystatechange=function(){s.addEventListener("error",(function(t){e(t)})),4===s.readyState&&200===s.status&&t(JSON.parse(s.responseText))},a?(s.upload.onprogress=i,s.send(a)):s.send()}));return u.xhr=s,u},i.prototype.sts=function(){var t=(new Date).toISOString(),e={bucket:this.option.bucketName,inseconds:this.option.inseconds},o={"X-Gos-Date":t};return this.ajax(this.option.stsPath,e,o,"GET",!0)},i.prototype.upload=function(t){var e=this;return e.sts().then((function(o){var n=(new Date).toISOString();if(0===o.retCode){e.ak=o.data.ak,e.sk=o.data.sk;var r={ak:e.ak,key:e.option.bucketPath+"/"+t.name},a={"Content-Length":String(t.size),"Content-MD5":"1111","X-Gos-Date":n},i=e.ajax(e.option.uploadPath,r,a,"PUT",!1,t,(function(o){if(o.lengthComputable){var n=Math.round(o.loaded/o.total*100);t.process=n,e.option.uploadProgress(o,t,t.process)}}));return t.process=0,t.xhrArr=[i.xhr],e.option.beforeUpload(t),i.then((function(o){return 0===o.retCode?(t.ignore=!0,e.option.fileUploaded(t,o.data,o),Promise.resolve(o)):Promise.reject(o)}))}return Promise.reject(o)})).catch((function(t){return Promise.reject(t)}))},i.prototype.upload2Init=function(t){var e=this;return this.sts().then((function(o){var n=(new Date).toISOString();if(0===o.retCode){e.ak=o.data.ak,e.sk=o.data.sk;var r={ak:e.ak,key:e.option.bucketPath+"/"+t.name},a={"X-Gos-Date":n};return e.ajax(e.option.initPart,r,a,"GET")}return Promise.reject(o.retMsg)}))},i.prototype.upload2Part=function(t,e,o){var n=this,r=(new Date).toISOString(),a={ak:n.ak,key:n.option.bucketPath+"/"+e.name,uploadId:e.uploadId,partNumber:String(o)},i={"Content-Length":String(e.size),"Content-MD5":"1111","X-Gos-Date":r};return n.ajax(n.option.uploadPart,a,i,"PUT",!1,e,(function(e){if(e.lengthComputable){var r=Math.round(e.loaded/e.total*100);t.process[o-1]=r/t.len,n.option.uploadProgress(e,t,t.process.reduce((function(t,e){return t+e})))}}))},i.prototype.upload2Comp=function(t){var e=(new Date).toISOString(),o={ak:this.ak,key:this.option.bucketPath+"/"+t.name,uploadId:t.uploadId},n={"X-Gos-Date":e};return this.ajax(this.option.compPart,o,n,"GET")},i.prototype.upload2=function(t){var e=this,o=[],n=Math.ceil(t.size/e.size);return this.upload2Init(t).then((function(r){if(0===r.retCode){t.uploadId=r.data.UploadId,t.process=[],t.xhrArr=[],t.len=n,e.option.beforeUpload(t);for(var a=0;a<n;a++){var i=t.slice(a*e.size,(a+1)*e.size);i.uploadId=t.uploadId,i.name=t.name;var s=e.upload2Part(t,i,a+1);t.xhrArr.push(s.xhr),o.push(s)}return Promise.all(o).then((function(o){for(var n in o)if(0!==o[n].retCode)return Promise.reject(o[n]);return e.upload2Comp(t).then((function(o){return 0===o.retCode?(t.ignore=!0,e.option.fileUploaded(t,o.data),Promise.resolve(o)):Promise.reject(o)}))})).catch((function(t){return Promise.reject(t)}))}return Promise.reject(r)})).catch((function(t){return Promise.reject(t)}))},i.prototype.upload2Abort=function(t){var e=(new Date).toISOString(),o={ak:this.ak,key:this.option.bucketPath+"/"+t.name,uploadId:t.uploadId},n={"X-Gos-Date":e};return this.ajax(this.option.abortPart,o,n,"GET")},i.prototype.getMediaMeta=function(t){var e=this;return new Promise((function(o,n){var r="";r=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");var a=new FormData;a.append("url",t),a.append("timestamp",(new Date).getTime()),r.withCredentials=!1,r.open("POST","".concat(e.option.host).concat(e.option.getMediaMeta),!1),r.onreadystatechange=function(){r.addEventListener("error",(function(t){n(t)})),4===r.readyState&&200===r.status?o(JSON.parse(r.responseText)):n()},r.send(a)})).then((function(t){return 0===t.retCode?Promise.resolve(t):Promise.reject(t)})).catch((function(t){return Promise.reject(t)}))}}}]);